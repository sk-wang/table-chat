# Tasks: Agent ä¾§è¾¹æ é‡æ„ (å‰ç«¯ UI é‡åš)

**Input**: åç«¯ API å·²å®Œæˆï¼Œå‰ç«¯éœ€è¦é‡æ„  
**Prerequisites**: åç«¯ Agent API (SSE) âœ… å·²å°±ç»ª
**éœ€æ±‚å˜æ›´**: å°† Agent ä»é€‰é¡¹å¡æ¨¡å¼æ”¹ä¸ºå³ä¾§å¯æ”¶èµ·çš„ä¾§è¾¹æ ï¼Œç±»ä¼¼ Cursor

**Organization**: æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡ï¼Œä¸“æ³¨å‰ç«¯é‡æ„

## Format: `[ID] [P?] [Story?] Description`

- **[P]**: å¯å¹¶è¡Œæ‰§è¡Œï¼ˆä¸åŒæ–‡ä»¶ï¼Œæ— ä¾èµ–ï¼‰
- **[Story]**: ä»»åŠ¡æ‰€å±ç”¨æˆ·æ•…äº‹ (US1, US2, US3)

---

## Phase 1: æ¸…ç†æ—§ä»£ç 

**Purpose**: ç§»é™¤æ—§çš„ Agent é€‰é¡¹å¡å®ç°

- [X] T001 ç§»é™¤ `frontend/src/pages/query/index.tsx` ä¸­ Agent é€‰é¡¹å¡ç›¸å…³ä»£ç 
- [X] T002 [P] æ¸…ç† `frontend/src/components/agent/AgentChat.tsx` ä¸­çš„è°ƒè¯•æ—¥å¿—

**Checkpoint**: æŸ¥è¯¢é¡µé¢å›å½’åˆ°åªæœ‰ SQL/è‡ªç„¶è¯­è¨€ä¸¤ä¸ªé€‰é¡¹å¡

---

## Phase 2: ä¾§è¾¹æ å¸ƒå±€ (Priority: P1) ğŸ¯ MVP

**Goal**: åˆ›å»ºå³ä¾§å¯æ”¶èµ·çš„ Agent ä¾§è¾¹æ 

**Independent Test**: ç‚¹å‡»ä¾§è¾¹æ æŒ‰é’®å¯ä»¥å±•å¼€/æ”¶èµ· Agent é¢æ¿

### å¸ƒå±€ç»„ä»¶

- [X] T003 [US1] åˆ›å»º `frontend/src/components/agent/AgentSidebar.tsx`ï¼š
  - å¯æ”¶èµ·/å±•å¼€çš„ä¾§è¾¹æ å®¹å™¨
  - é»˜è®¤æ”¶èµ·çŠ¶æ€ï¼Œæ˜¾ç¤ºä¸€ä¸ª AI å›¾æ ‡æŒ‰é’®
  - å±•å¼€æ—¶å®½åº¦çº¦ 400pxï¼Œå¯æ‹–æ‹½è°ƒæ•´
  - ä½¿ç”¨ Ant Design Drawer æˆ–è‡ªå®šä¹‰å®ç°

- [X] T004 [US1] æ›´æ–° `frontend/src/pages/query/index.tsx`ï¼š
  - åœ¨æœ€å¤–å±‚ Layout æ·»åŠ å³ä¾§ Agent ä¾§è¾¹æ 
  - ä¾§è¾¹æ ä¸å½±å“åŸæœ‰çš„ SQL ç¼–è¾‘å™¨å’Œç»“æœåŒºåŸŸ
  - æ·»åŠ å…¨å±€çŠ¶æ€æ§åˆ¶ä¾§è¾¹æ å±•å¼€/æ”¶èµ·

**Checkpoint**: å¯ä»¥ç‚¹å‡»æŒ‰é’®å±•å¼€/æ”¶èµ·å³ä¾§ Agent é¢æ¿

---

## Phase 3: Agent äº¤äº’é‡æ„ (Priority: P1)

**Goal**: é‡å†™ Agent èŠå¤©ç»„ä»¶ï¼Œç¡®ä¿ SSE äº‹ä»¶æ­£ç¡®å¤„ç†

### æ ¸å¿ƒç»„ä»¶é‡å†™

- [X] T005 [US1] é‡å†™ `frontend/src/components/agent/AgentChat.tsx`ï¼š
  - ç®€åŒ–çŠ¶æ€ç®¡ç†ï¼Œä½¿ç”¨ useReducer æ›¿ä»£å¤šä¸ª useState
  - ä¿®å¤ SSE äº‹ä»¶å¤„ç†ï¼Œç¡®ä¿å®æ—¶æ˜¾ç¤º
  - æ·»åŠ æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“
  - æ·»åŠ è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®

- [X] T006 [P] [US2] é‡å†™ `frontend/src/components/agent/AgentMessage.tsx`ï¼š
  - ç”¨æˆ·æ¶ˆæ¯æ ·å¼ï¼ˆå³å¯¹é½ï¼Œè“è‰²èƒŒæ™¯ï¼‰
  - åŠ©æ‰‹æ¶ˆæ¯æ ·å¼ï¼ˆå·¦å¯¹é½ï¼Œç°è‰²èƒŒæ™¯ï¼‰
  - æ”¯æŒ Markdown æ¸²æŸ“

- [X] T007 [P] [US2] é‡å†™ `frontend/src/components/agent/ToolCallBlock.tsx`ï¼š
  - å¯æŠ˜å çš„å·¥å…·è°ƒç”¨å¡ç‰‡
  - æ˜¾ç¤ºå·¥å…·åã€è¾“å…¥å‚æ•°ã€è¾“å‡ºç»“æœ
  - æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€å’Œè€—æ—¶

- [X] T008 [P] [US2] æ›´æ–° `frontend/src/components/agent/ThinkingIndicator.tsx`ï¼š
  - ç®€åŒ–åŠ¨ç”»æ•ˆæœ
  - æ˜¾ç¤ºå½“å‰çŠ¶æ€æ–‡å­—

**Checkpoint**: Agent å¯¹è¯å¯ä»¥æ­£å¸¸æ˜¾ç¤ºæ¶ˆæ¯å’Œå·¥å…·è°ƒç”¨

---

## Phase 4: SSE äº‹ä»¶å¤„ç†ä¿®å¤ (Priority: P1)

**Goal**: ç¡®ä¿ SSE äº‹ä»¶æ­£ç¡®è§£æå’Œæ˜¾ç¤º

- [X] T009 [US1] é‡æ„ `frontend/src/services/api.ts` agentQuery æ–¹æ³•ï¼š
  - ä½¿ç”¨åŸç”Ÿ EventSource API æ›¿ä»£æ‰‹åŠ¨è§£æ
  - æˆ–è€…ä¿®å¤å½“å‰çš„ SSE è§£æé€»è¾‘
  - æ·»åŠ è¯¦ç»†é”™è¯¯å¤„ç†

- [X] T010 [US1] åˆ›å»º `frontend/src/hooks/useAgentChat.ts`ï¼š
  - å°è£… Agent èŠå¤©çŠ¶æ€ç®¡ç†
  - å°è£… SSE è¿æ¥å’Œäº‹ä»¶å¤„ç†
  - æä¾› sendMessage, cancel ç­‰æ–¹æ³•

**Checkpoint**: å‘é€æ¶ˆæ¯åå¯ä»¥å®æ—¶çœ‹åˆ°æµå¼å“åº”

---

## Phase 5: äº¤äº’ç»†èŠ‚ (Priority: P2)

**Goal**: å®Œå–„ç”¨æˆ·äº¤äº’ä½“éªŒ

- [X] T011 [US3] å®ç° SQL å¤åˆ¶åˆ°ç¼–è¾‘å™¨åŠŸèƒ½ï¼š
  - Agent ç”Ÿæˆ SQL åæ˜¾ç¤º"å¤åˆ¶åˆ°ç¼–è¾‘å™¨"æŒ‰é’®
  - ç‚¹å‡»åå°† SQL å¡«å……åˆ°ä¸»ç¼–è¾‘å™¨

- [X] T012 [P] [US2] æ·»åŠ æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨ï¼š
  - æ–°æ¶ˆæ¯æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  - ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨æ—¶æš‚åœè‡ªåŠ¨æ»šåŠ¨

- [X] T013 [P] [US1] æ·»åŠ å–æ¶ˆè¯·æ±‚åŠŸèƒ½ï¼š
  - æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
  - ç‚¹å‡»åä¸­æ–­ SSE è¿æ¥

**Checkpoint**: ç”¨æˆ·ä½“éªŒæµç•…ï¼ŒåŠŸèƒ½å®Œæ•´

---

## Phase 6: æ ·å¼ç¾åŒ– (Priority: P3)

**Goal**: ç»Ÿä¸€æ ·å¼ï¼Œæå‡è§†è§‰æ•ˆæœ

- [X] T014 [P] åˆ›å»º `frontend/src/components/agent/styles.css`ï¼š
  - ä¾§è¾¹æ æ·±è‰²ä¸»é¢˜æ ·å¼
  - æ¶ˆæ¯æ°”æ³¡æ ·å¼
  - å·¥å…·è°ƒç”¨å¡ç‰‡æ ·å¼
  - åŠ¨ç”»è¿‡æ¸¡æ•ˆæœ

- [X] T015 [P] æ·»åŠ å“åº”å¼å¸ƒå±€æ”¯æŒï¼š
  - å°å±å¹•ä¸‹ä¾§è¾¹æ å…¨å±è¦†ç›–
  - è§¦æ‘¸å‹å¥½çš„äº¤äº’

**Checkpoint**: è§†è§‰æ•ˆæœç¬¦åˆç°ä»£è®¾è®¡æ ‡å‡†

---

## Phase 7: Markdown æ¸²æŸ“æ”¯æŒ (Priority: P2)

**Goal**: æ”¯æŒ Agent æ¶ˆæ¯çš„ Markdown æ ¼å¼æ¸²æŸ“ï¼ŒåŒ…æ‹¬ä»£ç é«˜äº®

**éœ€æ±‚**: ä½¿ç”¨ `marked` åº“è§£æ Markdownï¼Œæ”¯æŒï¼š
- æ ‡é¢˜ã€åŠ ç²—ã€æ–œä½“ç­‰åŸºæœ¬æ ¼å¼
- ä»£ç å—è¯­æ³•é«˜äº® (SQLã€JavaScript ç­‰)
- è¡Œå†…ä»£ç æ ·å¼
- åˆ—è¡¨ã€å¼•ç”¨ç­‰

### ä»»åŠ¡

- [X] T016 å®‰è£… `marked` ä¾èµ–ï¼š
  ```bash
  cd frontend && npm install marked
  ```

- [X] T017 [P] åˆ›å»º `frontend/src/components/agent/MarkdownRenderer.tsx`ï¼š
  - ä½¿ç”¨ marked è§£æ Markdown
  - è‡ªå®šä¹‰ä»£ç å—æ¸²æŸ“å™¨ï¼ˆæ·±è‰²ä¸»é¢˜æ ·å¼ï¼‰
  - å¤„ç† XSS å®‰å…¨ï¼ˆsanitize HTMLï¼‰
  - æ”¯æŒ SQL ä»£ç å—ç‰¹æ®Šæ ·å¼

- [X] T018 [P] æ›´æ–° `frontend/src/components/agent/AgentMessage.tsx`ï¼š
  - ä½¿ç”¨ MarkdownRenderer æ¸²æŸ“ assistant æ¶ˆæ¯
  - ä¿æŒ user æ¶ˆæ¯ä¸ºçº¯æ–‡æœ¬

- [X] T019 æ›´æ–° `frontend/src/components/agent/styles.css`ï¼š
  - æ·»åŠ  Markdown å…ƒç´ æ ·å¼ï¼ˆh1-h6, code, pre, blockquote ç­‰ï¼‰
  - ä»£ç å—æ·±è‰²ä¸»é¢˜æ ·å¼
  - è¡Œå†…ä»£ç æ ·å¼

**Checkpoint**: Agent å›å¤çš„ Markdown å†…å®¹æ­£ç¡®æ¸²æŸ“ï¼Œä»£ç å—æœ‰è¯­æ³•é«˜äº®

---

## Dependencies & Execution Order

```
Phase 1: æ¸…ç†æ—§ä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                             â†“
Phase 2: ä¾§è¾¹æ å¸ƒå±€ (MVP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                             â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â†“                                   â†“
Phase 3: Agent äº¤äº’é‡æ„          Phase 4: SSE ä¿®å¤
         â†“                                   â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                             â†“
Phase 5: äº¤äº’ç»†èŠ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                             â†“
Phase 6: æ ·å¼ç¾åŒ–
```

### Task Dependencies

**Phase 2 (å¸ƒå±€)**:
```
T003 (ä¾§è¾¹æ ç»„ä»¶) â†’ T004 (é›†æˆåˆ°é¡µé¢)
```

**Phase 3-4 (æ ¸å¿ƒåŠŸèƒ½)**:
```
T009 (SSEä¿®å¤) â”€â”€â†’ T010 (Hookå°è£…) â”€â”€â†’ T005 (Chatç»„ä»¶)
T006, T007, T008 å¯å¹¶è¡Œ
```

---

## Implementation Strategy

### MVP First (Phase 1-4)

1. å®Œæˆ Phase 1: æ¸…ç†æ—§ä»£ç 
2. å®Œæˆ Phase 2: åˆ›å»ºä¾§è¾¹æ å¸ƒå±€
3. å®Œæˆ Phase 3-4: é‡å†™æ ¸å¿ƒç»„ä»¶å’Œ SSE å¤„ç†
4. **éªŒè¯**: å¯ä»¥æ­£å¸¸å±•å¼€ä¾§è¾¹æ ã€å‘é€æ¶ˆæ¯ã€çœ‹åˆ°å®æ—¶å“åº”

### å…³é”®æŠ€æœ¯å†³ç­–

**1. SSE å¤„ç†æ–¹æ¡ˆ**:
ä½¿ç”¨ EventSource API æˆ– fetch + ReadableStreamï¼Œç¡®ä¿ï¼š
- äº‹ä»¶å®æ—¶è§¦å‘ React çŠ¶æ€æ›´æ–°
- æ­£ç¡®å¤„ç†å¤šè¡Œæ•°æ®
- ä¼˜é›…å¤„ç†è¿æ¥æ–­å¼€

**2. çŠ¶æ€ç®¡ç†**:
```typescript
// useReducer ç®¡ç†å¤æ‚çŠ¶æ€
type AgentState = {
  status: 'idle' | 'connecting' | 'streaming' | 'done' | 'error';
  messages: AgentMessage[];
  streamingText: string;
  error: string | null;
};

type AgentAction = 
  | { type: 'START' }
  | { type: 'TEXT_DELTA'; text: string }
  | { type: 'TOOL_CALL'; data: ToolCallData }
  | { type: 'MESSAGE'; data: MessageData }
  | { type: 'DONE' }
  | { type: 'ERROR'; error: string }
  | { type: 'RESET' };
```

**3. ä¾§è¾¹æ å¸ƒå±€**:
```tsx
<Layout style={{ height: '100%' }}>
  <Content>
    {/* åŸæœ‰çš„ SQL ç¼–è¾‘å™¨å’Œç»“æœåŒºåŸŸ */}
  </Content>
  <AgentSidebar 
    collapsed={!agentOpen} 
    onCollapse={() => setAgentOpen(false)}
    dbName={selectedDatabase?.name}
    onSQLGenerated={handleSQLGenerated}
  />
</Layout>
```

---

## Summary

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| **æ€»ä»»åŠ¡æ•°** | 19 |
| **Phase 1 (æ¸…ç†)** | 2 âœ… |
| **Phase 2 (å¸ƒå±€ - MVP)** | 2 âœ… |
| **Phase 3 (äº¤äº’é‡æ„)** | 4 âœ… |
| **Phase 4 (SSEä¿®å¤)** | 2 âœ… |
| **Phase 5 (äº¤äº’ç»†èŠ‚)** | 3 âœ… |
| **Phase 6 (æ ·å¼)** | 2 âœ… |
| **Phase 7 (Markdown)** | 4 âœ… |
| **å¹¶è¡Œä»»åŠ¡æ•°** | 10 |

---

## Notes

- åç«¯ API å·²å®Œæˆï¼Œæœ¬ä»»åŠ¡åªæ¶‰åŠå‰ç«¯é‡æ„
- é‡ç‚¹è§£å†³ SSE äº‹ä»¶å¤„ç†é—®é¢˜
- ä¾§è¾¹æ è®¾è®¡å‚è€ƒ Cursor çš„ AI é¢æ¿
- ä¿æŒä¸ç°æœ‰æ·±è‰²ä¸»é¢˜ä¸€è‡´
