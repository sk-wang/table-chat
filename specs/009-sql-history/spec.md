# Feature Specification: SQL执行历史记录

**Feature Branch**: `009-sql-history`  
**Created**: 2025-12-29  
**Status**: ⏳ UI Enhancement in Progress (Phase 7)  
**Input**: User description: "增加SQL执行记录日志功能，方便回顾过去执行的SQL记录，包括执行的SQL、返回的条数、执行的时间；如果是自然语言生成的话还要记录对应的自然语言。执行记录的日志支持搜索SQL内容，需要加上全文索引，用sqlite的fts和jieba分词支持中文搜索"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看历史执行记录 (Priority: P1)

用户在执行SQL查询后，希望能够查看自己过去执行的所有SQL记录，了解每条SQL的执行时间、返回行数等信息，以便快速复用之前的查询。

**Why this priority**: 这是执行历史功能的核心价值，没有历史记录展示，其他搜索功能都没有意义。

**Independent Test**: 可以通过执行几条SQL后，打开历史记录面板查看记录是否正确显示来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户已执行多条SQL查询, **When** 用户点击"执行历史"Tab页, **Then** 应按时间倒序显示所有历史记录，包含SQL内容、执行时间、返回行数
2. **Given** 用户执行一条新的SQL查询, **When** 查询执行完成, **Then** 该查询应自动添加到执行历史的最顶部
3. **Given** 用户查看执行历史列表, **When** 点击某条历史记录, **Then** 该SQL语句应复制到查询编辑器中以便复用
4. **Given** 用户在查看执行结果Tab, **When** 点击"执行历史"Tab, **Then** 应切换显示历史记录列表

---

### User Story 2 - 搜索历史记录 (Priority: P1)

用户希望能够通过关键词快速搜索之前执行的SQL记录，支持中文关键词搜索，方便在大量历史记录中快速找到目标SQL。

**Why this priority**: 当历史记录数量增多时，搜索是快速定位目标记录的唯一高效方式。

**Independent Test**: 可以通过创建多条包含不同关键词的历史记录，然后搜索特定关键词验证搜索结果的准确性。

**Acceptance Scenarios**:

1. **Given** 用户有多条执行历史记录, **When** 用户输入SQL关键词进行搜索, **Then** 显示所有包含该关键词的历史记录
2. **Given** 用户使用自然语言生成的SQL有历史记录, **When** 用户输入自然语言中的中文关键词搜索, **Then** 能够匹配到对应的记录
3. **Given** 搜索结果列表, **When** 用户清空搜索框, **Then** 恢复显示所有历史记录

---

### User Story 3 - 自然语言查询记录关联 (Priority: P2)

当用户通过自然语言描述生成SQL时，系统需要同时记录原始的自然语言描述，方便用户回顾当时的查询意图。

**Why this priority**: 这是增强型功能，为使用AI生成SQL的用户提供更好的回溯体验。

**Independent Test**: 可以通过自然语言输入生成SQL并执行后，在历史记录中验证是否同时显示自然语言描述。

**Acceptance Scenarios**:

1. **Given** 用户通过自然语言描述生成并执行SQL, **When** 查看执行历史, **Then** 应同时显示自然语言描述和生成的SQL
2. **Given** 用户直接手写SQL并执行, **When** 查看执行历史, **Then** 只显示SQL内容，自然语言字段为空

---

### Edge Cases

- 当搜索关键词无匹配结果时，应显示友好的空状态提示
- SQL执行失败时不记录到历史
- 当历史记录数量极大（如1万条以上）时，列表加载应有分页或虚拟滚动
- 超长SQL语句在列表中应截断显示，完整内容在详情中展示
- 特殊字符（如SQL注释、引号）的搜索应正常工作
- 首次使用时历史记录为空，应显示引导提示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 记录每次成功执行的SQL查询，包含：SQL语句全文、执行时间戳、返回行数、执行耗时
- **FR-002**: 系统 MUST 在用户通过自然语言生成SQL时，同时记录原始自然语言描述
- **FR-003**: 系统 MUST 提供执行历史Tab页（与查询结果Tab并列），按执行时间倒序排列显示历史记录
- **FR-004**: 系统 MUST 提供搜索功能，支持在SQL内容和自然语言描述中进行全文搜索
- **FR-005**: 系统 MUST 支持中文关键词的搜索，搜索结果应包含分词后的中文匹配
- **FR-006**: 用户 MUST 能够点击历史记录将SQL复制到查询编辑器
- **FR-007**: 系统 MUST 在历史记录列表中分页加载或虚拟滚动，避免大量数据时的性能问题
- **FR-008**: 系统 MUST 对SQL内容和自然语言描述建立全文索引以支持高效搜索
- **FR-009**: 系统 MUST 将执行历史数据持久化存储，应用重启后数据不丢失

### Key Entities

- **QueryHistory（查询历史）**: 表示一条SQL执行记录，包含SQL语句、自然语言描述（可选）、执行时间、返回行数、执行耗时、所属数据库连接
- **SearchIndex（搜索索引）**: 存储分词后的SQL和自然语言内容，支持全文搜索

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能够在3秒内找到一周内执行过的任意SQL记录
- **SC-002**: 中文关键词搜索准确率达到90%以上（搜索结果包含预期记录）
- **SC-003**: 历史记录列表在10000条记录时仍能在1秒内完成首屏加载
- **SC-004**: 用户从打开历史面板到复用SQL到查询编辑器的操作在5秒内完成
- **SC-005**: 历史记录支持搜索SQL内容和自然语言描述两种维度

## Assumptions

- 执行历史数据存储在本地SQLite数据库中，不涉及远程同步
- 只记录成功执行的SQL查询，失败的查询不进入历史记录
- 中文分词使用jieba分词库处理
- 历史记录按数据库连接隔离，每个连接有独立的历史记录
- 历史记录无数量上限，永久保留，不自动清理（已确认）
- 不提供历史记录删除功能，仅支持查看和复用（已确认）
- UI采用Tab页形式，与查询结果Tab并列显示（已确认，参考阿里云DMS）
- UI采用表格形式显示历史记录，参考阿里云云效执行历史界面（Phase 7 新增）
